# 江西微校通

## 工程化搭建
`package.json`
```json
{
  "name": "admin",
  "private": true,
  "version": "0.0.0",
  "scripts": {
    "postinstall": "husky install",
    "start": "vite --host 0.0.0.0",
    "build": "vite build",
    "build:staging": "vite build --mode staging",
    "preview": "vite preview"
  },
  "dependencies": {
    "@element-plus/icons-vue": "^1.1.4",
    "@sentry/tracing": "^6.19.7",
    "@sentry/vue": "^6.19.7",
    "@vueuse/core": "^8.2.6",
    "ali-oss": "^6.17.1",
    "axios": "^0.26.1",
    "dayjs": "^1.11.1",
    "element-plus": "^2.2.5",
    "html2canvas": "^1.4.1",
    "jsoneditor": "^9.7.4",
    "marked": "^4.0.14",
    "md5": "^2.3.0",
    "normalize.css": "^8.0.1",// Normalize.css是一种CSS reset的替代方案。https://jerryzou.com/posts/aboutNormalizeCss/
    "nprogress": "^0.2.0",// NProgress是页面跳转是出现在浏览器顶部的进度条 https://ricostacruz.com/nprogress/ https://www.jianshu.com/p/346c05d4d9d8
    "path-browserify": "^1.0.1",// 整合 vite 后，path模块会报错，原因是 vite 源码中设定了不允许在客户端代码中访问内置模块代码，使用 path-browserify 代替 path 模块 https://juejin.cn/post/7130090422651191333
    "path-to-regexp": "^6.2.0", // 该方法的作用是把字符串转为正则表达式。一个对URL进行解析的模块，支持正则表达式验证、匹配、反向解析，可用于增加 koa 框架对于 koa-router 对 path 的解析工作。
    "pinia": "^2.0.13",
    "qrcode-vue3": "1.4.15",
    "socket.io-client": "^4.5.0",
    "sortablejs": "^1.15.0",
    "vue": "^3.2.25",
    "vue-qr": "^4.0.6",
    "vue-router": "^4.0.14",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@types/ali-oss": "^6.16.3",
    "@types/jsoneditor": "^9.5.1",
    "@types/marked": "^4.0.3",
    "@types/md5": "^2.3.2",
    "@types/nprogress": "^0.2.0",
    "@types/path-browserify": "^1.0.0",
    "@types/path-to-regexp": "^1.7.0",
    "@types/sortablejs": "^1.10.7",
    "@typescript-eslint/eslint-plugin": "^5.19.0",
    "@typescript-eslint/parser": "^5.19.0",
    "@vitejs/plugin-vue": "^2.3.1", // 框架自带
    "cross-env": "^7.0.3", // 就是针对相同的语句和命令，我们希望这条语句能够同时在 Windows 和 Linux 上使用。 https://juejin.cn/post/7006650325931130916
    "eslint": "^8.13.0",
    "eslint-config-airbnb-base": "^15.0.0",
    "eslint-config-airbnb-typescript": "^17.0.0",
    "eslint-config-prettier": "^8.5.0",
    "eslint-import-resolver-typescript": "^2.7.1",
    "eslint-plugin-import": "^2.26.0",
    "eslint-plugin-prettier": "^4.0.0",
    "eslint-plugin-vue": "^8.6.0",
    "husky": "^7.0.4",
    "lint-staged": "^12.3.8",
    "prettier": "^2.6.2",
    "rollup-plugin-external-globals": "^0.6.1",
    "sass": "^1.50.0",
    "typescript": "^4.5.4",
    "vite": "^2.9.2",
    "vite-plugin-pwa": "^0.11.13",
    "vite-plugin-svg-icons": "^2.0.1", // 当你使用该插件的时候，指定好存放svg的文件夹。再按照指定的方式去访问svg图片。就可以再不产生http请求的情况下渲染出svg图片。// https://www.kuxiaoxin.com/archives/66
    "vue-tsc": "^0.29.8",
    "workbox-window": "^6.5.3"
  }
}
```
### 分析
技术栈
- 编程语言： typescript
- 构建工具：vite
- 语言框架：vue3
- 路由管理：vue-router
- 状态管理：pinia
- UI框架：element-plus
- CSS预编译：scss
- 代码规范：prettier&eslint
- 提交规范：husky&lint-staged
<!-- - 桌面应用：electron -->

### 从头开始

#### Vite
node 14.18+ or 16+
```bash
npm create vite@latest
yarn create vite
pnpm create vite

# 结果
✔ Project name: … project
✔ Select a framework: › vue
✔ Select a variant: › vue-ts

Scaffolding project in /home/liming/code/temp/project...

Done. Now run:

  cd project
  pnpm install
  pnpm run dev

--------------------------------------------------------------------------------
~/code/temp »
```

打开文件夹会发现
![](assets/images/vite-start.png)


此时的`package.json`文件如下:
```json
{
  "name": "project",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc --noEmit && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "vue": "^3.2.37"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^3.0.3",
    "typescript": "^4.6.4",
    "vite": "^3.0.7",
    "vue-tsc": "^0.39.5"
  }
}
```

再根目录增加一个`.nvmrc`文件来控制node版本
```
16.14.0
```
![](assets/images/nvmrc.png)

配置vite
> 配置前需要引入**path-browserify**包，因为整合 vite 后，path模块会报错，原因是 vite 源码中设定了不允许在客户端代码中访问内置模块代码，所以使用 path-browserify 代替 path 模块
```bash
pnpm i --save path-browserify
pnpm i --save-dev @types/path-browserify
```

`vite.config.ts`文件
```ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
// 找不到模块“path”或其相应的类型声明: pnpm i @types/node
// 请在tsconfig.json下compilerOptions增加"paths": {"@/*": ["src/*"]},  "baseUrl": ".",
import { resolve } from 'path' 

// https://vitejs.dev/config/
export default defineConfig({
  // https://cn.vitejs.dev/config/shared-options.html#resolve-alias
  // 当使用文件系统路径的别名时，请始终使用绝对路径。相对路径的别名值会原封不动地被使用，因此无法被正常解析。
  resolve: {
    alias: {
      '@/': `${resolve(__dirname, 'src')}/`
    }
  },
  plugins: [vue()]
})
```
`tsconfig.json`文件
```json
{
  "compilerOptions": {
    "target": "ESNext",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "moduleResolution": "Node",
    "strict": true,
    "jsx": "preserve",
    "sourceMap": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "esModuleInterop": true,
    "lib": ["ESNext", "DOM"],
    "skipLibCheck": true,
    // 新增
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*.ts", "src/**/*.d.ts", "src/**/*.tsx", "src/**/*.vue"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

cssreset
```bash
pnpm i --save normalize.css
```

再安装补充几个常用的Vue生态库
```bash
pnpm i --save @vueuse/core vue-router pinia 
```

pinia
在`src`目录下新建`store`文件夹，并新建文件`user.ts`
```ts
import { useLocalStorage } from "@vueuse/core";
import { defineStore } from "pinia";

const useUserStore = defineStore('user', {
  state: () => ({
    token: useLocalStorage<string | null>('token', null)
  }),
  actions: {
    logout() {
      this.token = null;
    }
  }
})

export default useUserStore;
```

在`src`目录下新建`views/dashboard/`文件夹，并新建文件`index.vue`
```vue
<template>
  <div>
    dashboard
  </div>
</template>
<script lang='ts' setup>
import { defineComponent, ref, reactive } from 'vue';
</script>
<script lang='ts'>
defineComponent({
  // 这里的name和路由的有什么区别？
  name: 'DashboardView', 
});
</script>
<style lang='scss' scoped>
</style>
```
在`src`目录下新建`views/login/`文件夹，并新建文件`index.vue`
```vue
<template>
  <div class="login-container">
    login
  </div>
</template>
<script lang='ts' setup>
import { defineComponent, ref, reactive } from 'vue';
</script>
<script lang='ts'>
defineComponent({
  name: 'LoginView', 
});
</script>
<style lang='scss' scoped>
.login-container {
  color: $blue;
  font-size: 20px;
}
</style>
```
在`src`目录下新建`views/notFount/`文件夹，并新建文件`index.vue`
```vue
<template>
  <div>
    404
  </div>
</template>
<script lang='ts' setup>
import { defineComponent, ref, reactive } from 'vue';
</script>
<script lang='ts'>
defineComponent({
  name: 'NotFountView', 
});
</script>
<style lang='scss' scoped>
</style>
```

在`src`目录下新建`views/log/`文件夹，并新建文件`index.vue`
```vue
<template>
  <div>
    SystemLogView
  </div>
</template>
<script lang='ts' setup>
import { defineComponent, ref, reactive } from 'vue';
</script>
<script lang='ts'>
defineComponent({
  name: 'SystemLogView', 
});
</script>
<style lang='scss' scoped>
</style>
```

router
在`src`目录下新建`router/route`文件夹，并新建文件`router/index.ts`和`routes/log.ts`
log.ts
```ts
import { RouteRecordRaw } from "vue-router";
const LogRoutes: Array<RouteRecordRaw> = [
  {
    path: '/log',
    name: 'Log',
    redirect: '/log/system',
    meta: { title: '日志管理', icon: 'vue' },
    // 嵌套路由的父路由样式(未定义)
    // component: Layout,
    children: [
      {
        path: '/log/system',
        name: 'SystemLogView',
        meta: { title: '系统日志', cache: true },
        component: () => import('@/views/log/index.vue')
      }
    ]
  }
]
export default LogRoutes;
```

index.ts
```ts
import { createRouter, createWebHashHistory, RouteRecordRaw } from "vue-router"
import logRoutes from './routes/log'

export const routes: Array<RouteRecordRaw> = [
  {
    path: '/',
    name: 'App',
    redirect: '/dashboard',
    children: [
      {
        path: '/dashboard',
        meta: { title: '首页', icon: "vue", affix: true, cache: true },
        name: 'DashboardView',
        component: () => import('@/views/dashboard/index.vue')
      }
    ]
  },
  ...logRoutes,
  {
    path: '/login',
    name: 'LoginView',
    meta: { title: '用户登录', icon: "vue", hidden: true },
    component: () => import('@/views/login/index.vue')
  },
  {
    // TODO 这是一种什么匹配模式
    path: '/:pathMatch(.*)*',
    name: 'NotFount',
    redirect: '/404'
  }
]

const router = createRouter({
  // 选择hash模式路由
  history: createWebHashHistory(),
  routes,
})

export default router;
```
当然还需要一个路由守卫`guard.ts`
```ts
import { NavigationGuardNext, RouteLocationNormalized } from 'vue-router';
import useUserStore from '@/store/user';
import router from './index';

// 白名单路由
const whiteList = ['/login']

router.beforeEach((to: RouteLocationNormalized, from: RouteLocationNormalized, next: NavigationGuardNext) => {
  const userStore = useUserStore()
  // 满足条件
  if(whiteList.includes(to.path)) return next();
  // 不满足条件
  if(!userStore.token) return next(`/login?redirect=${to.path}`);
  return next();
})
```

网络请求相关：

```bash
pnpm i --save axios
```
在`src`目录下新建`utils`文件夹，并新建文件`request.ts`
```ts
import router from '@/router';
import useUserStore from '@/store/user';
import axios, { AxiosError, AxiosInstance, AxiosRequestConfig, AxiosResponse } from 'axios';

class VAxios {
  private axiosInstance: AxiosInstance;

  private static VAxiosInstance: VAxios;

  private constructor(config: AxiosRequestConfig) {
    this.axiosInstance = axios.create(config);
    this.setRequestInterceptors();
    this.setResponseInterceptors();
  }

  /** 创建 axios 实例 */
  public static getInstance() {
    if (!this.VAxiosInstance) {
      this.VAxiosInstance = new this({
        baseURL: import.meta.env.VITE_BASE_API as string,
        timeout: 120000,
        headers: {
          'Content-Type': 'application/json; charset=utf-8',
          Accept: '*/*',
        },
      });
    }

    return this.VAxiosInstance;
  }

  /** 设置请求拦截器 */
  private setRequestInterceptors() {
    // 配置 && 错误处理
    this.axiosInstance.interceptors.request.use(
      (config: AxiosRequestConfig) => {
        config.headers!.Authorization = useUserStore().token as string;

        return config;
      },
      error => Promise.reject(error)
    );
  }

  /** 设置响应拦截器 */
  private setResponseInterceptors() {
    // 配置 && 错误处理
    this.axiosInstance.interceptors.response.use(
      (response: AxiosResponse) => response.data,

      (error: AxiosError | Error) => {
        if (!axios.isAxiosError(error)) return Promise.reject(error.message);
        if (!error.response) return Promise.reject(error.message);

        switch (error.response.status) {
          case 401:
            useUserStore().logout();
            return Promise.reject(new Error('请登陆后操作'));
          case 403:
            router.replace('/403');
            return Promise.reject(new Error('权限不足'));
          case 404:
            return Promise.reject(new Error('请求地址不存在'));
          case 500:
            return Promise.reject(new Error('服务器内部错误'));
          case 502:
            return Promise.reject(new Error('服务器网络错误'));
          default:
            return Promise.reject(
              typeof error.response.data === 'string' || error.response.data instanceof String
                ? error.response.data
                : error.response.data?.message ?? error.response.data?.error
            );
        }
      }
    );
  }

  /** 请求 */
  async request<T = any>(config: AxiosRequestConfig): Promise<T> {
    return this.axiosInstance.request(config);
  }

  /**
   * post
   * @param url 请求地址
   * @param data body参数
   * @param config axios 配置
   */
  async post<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<T> {
    return this.axiosInstance.post(url, data, config);
  }

  /**
   * delete
   * @param url 请求地址
   * @param config axios 配置
   */
  async delete<T = any>(url: string, config?: AxiosRequestConfig): Promise<T> {
    return this.axiosInstance.delete(url, config);
  }

  /**
   * put
   * @param url 请求地址
   * @param data body参数
   * @param config axios 配置
   */
  async put<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<T> {
    return this.axiosInstance.put(url, data, config);
  }

  /**
   * patch
   * @param url 请求地址
   * @param data body参数
   * @param config axios 配置
   */
  async patch<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<T> {
    return this.axiosInstance.patch(url, data, config);
  }

  /**
   * get
   * @param url 请求地址
   * @param config axios 配置
   */
  async get<T = any>(url: string, config?: AxiosRequestConfig): Promise<T> {
    return this.axiosInstance.get(url, config);
  }
}

export default VAxios.getInstance();
```

UI框架：
[官网](https://element-plus.org/zh-CN/guide/i18n.html)
```bash
pnpm i --save element-plus @element-plus/icons-vue
```

MD5加密:
```bash
pnpm i --save md5
pnpm i --save-dev @types/md5
```

CSS预编译：
```bash
pnpm i --save-dev sass
```
在`src`目录下新建`styles`文件夹，并新建文件`index.scss`
```scss
$blue: #abcdef;
$menuText: #bfc;
// TODO
:export {
  menuText: $menuText
}
```

使用插件让访问svg不用产生http请求
[github](https://github.com/vbenjs/vite-plugin-svg-icons/blob/main/README.zh_CN.md)
```bash 
pnpm i --save-dev vite-plugin-svg-icons
```
修改`vite.config.ts`中的插件plugins配置
```ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
// 找不到模块“path”或其相应的类型声明: pnpm i @types/node
// 请在tsconfig.json下compilerOptions增加"paths": {"@/*": ["src/*"]},  "baseUrl": ".",
import { resolve } from 'path' 

import { createSvgIconsPlugin } from 'vite-plugin-svg-icons'

// https://vitejs.dev/config/
export default defineConfig({
  // https://cn.vitejs.dev/config/shared-options.html#resolve-alias
  // 当使用文件系统路径的别名时，请始终使用绝对路径。相对路径的别名值会原封不动地被使用，因此无法被正常解析。
  resolve: {
    alias: {
      '@/': `${resolve(__dirname, 'src')}/`
    }
  },
  plugins: [
    vue(),
    createSvgIconsPlugin({
      // 指定要缓存的图标文件夹
      iconDirs: [resolve(process.cwd(), 'src/assets/svg')],
      // 执行 icon name 的格式
      symbolId: 'icon-[dir]-[name]',
    })
  ]
})
```

在`src/component/`下新建文件`SvgIcon.vue`
```vue
<template>
  <svg :class="svgClass" :style="style">
    <use :xlink:href="iconName" />
  </svg>
</template>

<script lang="ts" setup>
import { computed, toRefs } from 'vue';

const props = defineProps<{
  name?: string;
  style?: { [key: string]: string };
}>();

const { style } = toRefs(props);
const iconName = computed(() => `#icon-${props.name}`);
const svgClass = computed(() => (props.name ? `svg-icon icon-${props.name}` : 'svg-icon'));
</script>

<style lang="scss" scoped>
.svg-icon {
  fill: currentColor;
  vertical-align: middle;
  width: 1em;
  height: 1em;
}
</style>
```

将各个模块添加至`main.ts`中
src/App.vue
```vue
<template>
  <!-- 父级路由 -->
  <router-view></router-view>
</template>

<script setup lang="ts"></script>

<style scoped></style>
```

main.ts
```ts
import { createApp } from 'vue'
// import './style.css'
import router from '@/router'
import SvgIcon from '@/components/SvgIcon.vue'
import ElementPlus  from 'element-plus'
import 'normalize.css'
// 这是虚拟模块的引入方式，用于给脚手架插件在打包和开发时做相应的处理。Vite 和 Rollup 中都约定以 virtual: 作为虚拟模块的前缀：
import 'virtual:svg-icons-register' 
import { createPinia } from 'pinia'
// 国际化 
import ElementPlusLocaleZhCN from 'element-plus/es/locale/lang/zh-cn'
import App from './App.vue'
import '@/router/guard'

const app = createApp(App)
// 注意引用顺序
app.use(createPinia())
app.use(router)
app.use(ElementPlus, { locale: ElementPlusLocaleZhCN })
// 全局组件
app.component('SvgIcon', SvgIcon)

app.mount('#app')
```
哎？SCSS样式怎么没引入呢？
vite.config.ts
```ts
// https://vitejs.dev/config/
export default defineConfig({
  // https://cn.vitejs.dev/config/shared-options.html#resolve-alias
  // 当使用文件系统路径的别名时，请始终使用绝对路径。相对路径的别名值会原封不动地被使用，因此无法被正常解析。
  resolve: {
    alias: {
      '@/': `${resolve(__dirname, 'src')}/`
    }
  },
  plugins: [
    vue(),
    createSvgIconsPlugin({
      // 指定要缓存的图标文件夹
      iconDirs: [resolve(process.cwd(), 'src/assets/svg')],
      // 执行 icon name 的格式
      symbolId: 'icon-[dir]-[name]',
    })
  ],
  // 引入index.scss
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: `@import "./src/styles/index.scss";`,
      }
    }
  }
})
```

此时运行`pnpm start(dev)`发现报错了
```bash
failed to load config from /home/liming/code/temp/project/vite.config.ts
error when starting dev server:
Error [ERR_MODULE_NOT_FOUND]: Cannot find package 'fast-glob' imported from /home/liming/code/temp/project/node_modules/.pnpm/vite-plugin-svg-icons@2.0.1_vite@3.0.9/node_modules/vite-plugin-svg-icons/dist/index.mjs
```
于是安装它就可以了
```bash
pnpm i -D fast-glob
```

## 增加开发规范
