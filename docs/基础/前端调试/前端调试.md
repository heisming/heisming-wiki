# å‰ç«¯è°ƒè¯•
ä»¥ä¸‹æ˜¯ä¸»è¦å†…å®¹ï¼š
1. ç”¨ VSCode Debugger è°ƒè¯•ç½‘é¡µçš„ JSã€
2. ç”¨ VSCode Debugger è°ƒè¯• Node.jsã€
3. ç”¨ Chrome DevTools è°ƒè¯•ç½‘é¡µ
4. è°ƒè¯•å·¥å…·çš„åŸç†ã€‚

å¯ä»¥ç»™è°ƒè¯•ä¸‹ä¸ªå®šä¹‰ï¼š
> ä»£ç åœ¨æŸä¸ªå¹³å°è¿è¡Œï¼ˆæµè§ˆå™¨ã€Node.jsã€Electronã€å°ç¨‹åºç­‰ä»»ä½•èƒ½æ‰§è¡Œ JS ä»£ç çš„å¹³å°ï¼‰ï¼ŒæŠŠè¿è¡Œæ—¶çš„çŠ¶æ€ï¼ˆè°ƒç”¨æ ˆã€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæˆ–è€… DOM çš„ç»“æ„ï¼ŒReact ç»„ä»¶çš„çŠ¶æ€ç­‰ï¼‰é€šè¿‡æŸç§æ–¹å¼ï¼ˆä¸€èˆ¬æ˜¯é€šè¿‡åŸºäº WebSocket çš„è°ƒè¯•åè®®ï¼‰æš´éœ²å‡ºæ¥ï¼Œä¼ é€’ç»™å¼€å‘å·¥å…·åš UI çš„å±•ç¤ºå’Œäº¤äº’ï¼Œè¾…åŠ©å¼€å‘è€…æ’æŸ¥é—®é¢˜ã€æ¢³ç†æµç¨‹ã€äº†è§£ä»£ç è¿è¡ŒçŠ¶æ€ç­‰ï¼Œè¿™ä¸ªå°±æ˜¯è°ƒè¯•ã€‚

## åŸç†
### Chrome DevTools åŸç†
Chrome DevTools åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œbackend å’Œ frontendï¼š
- backend å’Œ Chrome é›†æˆï¼Œè´Ÿè´£æŠŠ Chrome çš„ç½‘é¡µè¿è¡Œæ—¶çŠ¶æ€é€šè¿‡è°ƒè¯•åè®®æš´éœ²å‡ºæ¥ã€‚
- frontend æ˜¯ç‹¬ç«‹çš„ï¼Œè´Ÿè´£å¯¹æ¥è°ƒè¯•åè®®ï¼Œåš UI çš„å±•ç¤ºå’Œäº¤äº’ã€‚

ä¸¤è€…ä¹‹é—´çš„è°ƒè¯•åè®®å«åš Chrome DevTools Protocolï¼Œç®€ç§° CDPã€‚

ä¼ è¾“åè®®æ•°æ®çš„æ–¹å¼å«åšä¿¡é“ï¼ˆmessage channelï¼‰ï¼Œæœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ Chrome DevTools åµŒå…¥åœ¨ Chrome é‡Œæ—¶ï¼Œä¸¤è€…é€šè¿‡å…¨å±€çš„å‡½æ•°é€šä¿¡ï¼›å½“ Chrome DevTools è¿œç¨‹è°ƒè¯•æŸä¸ªç›®æ ‡çš„ä»£ç æ—¶ï¼Œä¸¤è€…é€šè¿‡ WebSocket é€šä¿¡ã€‚

> frontendã€backendã€è°ƒè¯•åè®®ï¼ˆCDPï¼‰ã€ä¿¡é“ï¼Œè¿™æ˜¯ Chrome DevTools çš„ 4 ä¸ªç»„æˆéƒ¨åˆ†ã€‚

![](assets/img/chrome_devtools_principle.png)
[Chrome DevToolsåŸç†](./assets/drowio/chrome_devtools_principle.drawio ':include :type=code')

backend å¯ä»¥æ˜¯ Chromiumï¼Œä¹Ÿå¯ä»¥æ˜¯ Node.js æˆ–è€… V8ï¼Œè¿™äº› JS çš„è¿è¡Œæ—¶éƒ½æ”¯æŒ Chrome DevTools Protocolã€‚

è¿™å°±æ˜¯ Chrome DevTools çš„è°ƒè¯•åŸç†ã€‚

### VSCode Debugger åŸç†
å’Œ Chrome DevTools å·®ä¸å¤šï¼Œä¹Ÿæ˜¯åˆ†ä¸º frontendã€backendã€è°ƒè¯•åè®®è¿™å‡ éƒ¨åˆ†ï¼Œåªä¸è¿‡å®ƒå¤šäº†ä¸€å±‚é€‚é…å™¨åè®®ã€‚
![](assets/img/vscode_debugger_principle1.png)
[VSCode DebuggeråŸç†](./assets/drowio/VSCodeDebuggerProtocol.drawio ':include :type=code')

ä¸ºäº†èƒ½ç›´æ¥ç”¨ Chrome DevTools è°ƒè¯• Node.js ä»£ç ï¼ŒNode.js 6 ä»¥ä¸Šå°±ä½¿ç”¨ Chrome DevTools Protocol ä½œä¸ºè°ƒè¯•åè®®äº†ï¼Œæ‰€ä»¥ VSCode Debugger è¦è°ƒè¯• Node.js ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªåè®®ã€‚

ä½†æ˜¯ä¸­é—´å¤šäº†ä¸€å±‚é€‚é…å™¨åè®® Debug Adapter Protocolï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ
  å› ä¸º VSCode ä¸æ˜¯ JS ä¸“ç”¨ç¼–è¾‘å™¨å‘€ï¼Œå®ƒå¯èƒ½ç”¨æ¥è°ƒè¯• Python ä»£ç ã€Rust ä»£ç ç­‰ç­‰ï¼Œè‡ªç„¶ä¸èƒ½å’ŒæŸä¸€ç§è¯­è¨€çš„è°ƒè¯•åè®®æ·±åº¦è€¦åˆï¼Œæ‰€ä»¥å¤šäº†ä¸€ä¸ªé€‚é…å™¨å±‚ã€‚
![](assets/img/vscode_debugger_principle2.png)
[VSCode DebuggeråŸç†](./assets/drowio/VSCodeDebuggerAdapter.drawio.drawio ':include :type=code')

è¿™æ · VSCode Debugger å°±å¯ä»¥ç”¨åŒä¸€å¥— UI å’Œé€»è¾‘æ¥è°ƒè¯•å„ç§è¯­è¨€çš„ä»£ç ï¼Œåªè¦å¯¹æ¥ä¸åŒçš„ Debug Adapter åšåè®®è½¬æ¢å³å¯ã€‚

è¿˜æœ‰å¦ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯åˆ«çš„ç¼–è¾‘å™¨ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ª Debug Adapter Protocol æ¥å®ç°è°ƒè¯•ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥å¤ç”¨ VSCode çš„å„ç§è¯­è¨€çš„ Debug Adapter äº†ã€‚

> VSCode Debugger çš„ UI çš„éƒ¨åˆ†ç®—æ˜¯ frontendï¼Œè€Œè°ƒè¯•çš„ç›®æ ‡è¯­è¨€ç®—æ˜¯ backend éƒ¨åˆ†ï¼Œä¸­é—´ä¹Ÿæ˜¯é€šè¿‡ WebSocket ä¼ é€’è°ƒè¯•åè®®ã€‚

### Vue/React DevTools
ä»¥ Chrome æ’ä»¶ï¼ˆChrome Extensionï¼‰çš„å½¢å¼å­˜åœ¨çš„ï¼Œè¦ææ‡‚å®ƒä»¬çš„åŸç†å°±å¾—äº†è§£ Chrome æ’ä»¶çš„æœºåˆ¶ã€‚

Chrome æ’ä»¶ä¸­å¯ä»¥è®¿é—®ç½‘é¡µçš„ DOM çš„éƒ¨åˆ†å«åš Content Scriptï¼Œéšé¡µé¢å¯åŠ¨è€Œç”Ÿæ•ˆï¼Œå¯ä»¥å†™ä¸€äº›æ“ä½œ DOM çš„é€»è¾‘ã€‚è¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯åå°è¿è¡Œçš„ï¼Œå«åš Backgroundï¼Œæµè§ˆå™¨å¯åŠ¨å°±ç”Ÿæ•ˆäº†ï¼Œç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿ï¼Œå¯ä»¥åšä¸€äº›å¸¸é©»çš„é€»è¾‘ã€‚
![](assets/img/content_script.png)
å¦‚æœæ˜¯æ‰©å±• DevTools çš„ Chrome æ’ä»¶ï¼Œé‚£è¿˜æœ‰ä¸€éƒ¨åˆ† DevTools Pageï¼Œæ˜¯åœ¨ DevTools é‡Œæ˜¾ç¤ºçš„é¡µé¢ï¼š
![](assets/img/devTools_page.png)
- Content Script éƒ¨åˆ†å¯ä»¥æ“ä½œ DOMï¼Œå¯ä»¥ç›‘å¬ DOM Eventã€‚
- Backgroud éƒ¨åˆ†å¯ä»¥è®¿é—® extension apiï¼Œå¯ä»¥å’Œ Content Script è¿˜æœ‰ DevTools Page é€šä¿¡ã€‚
- DevTools Page éƒ¨åˆ†å¯ä»¥è®¿é—® devtools apiï¼Œå¯ä»¥å‘å½“å‰ window æ³¨å…¥ JS æ‰§è¡Œã€‚

Vue DevTools å’Œ React DevTools å°±æ˜¯åŸºäºChromeæ’ä»¶æ¶æ„æ¥å®ç°çš„è°ƒè¯•åŠŸèƒ½ã€‚

çœ‹ [Vue DevTools çš„æºç ç›®å½•](https://github.com/vuejs/devtools/tree/main/packages)ä¼šå‘ç°ï¼Œå®ƒä¹Ÿæ˜¯åˆ†ä¸º backend å’Œ frontend çš„
![](assets/img/vue_devtools_source_code.png)

é‚£ backend è¿è¡Œåœ¨å“ªï¼Œfrontend è¿è¡Œåœ¨å“ªï¼Œä¸¤è€…æ€ä¹ˆé€šä¿¡å‘¢ï¼Ÿ
- DevTools Page æ˜¯å¯ä»¥åœ¨é¡µé¢ eval JS çš„ï¼Œé‚£å°±å¯ä»¥æ³¨å…¥ backend çš„ä»£ç ã€‚
- backend çš„ä»£ç å¯ä»¥æ‹¿åˆ° Vue ç»„ä»¶çš„ä¿¡æ¯ï¼Œé€šè¿‡ window message çš„æ–¹å¼ä¼ é€’ç»™ Backgroundã€‚
- Background å¯ä»¥å’Œ DevTools Page é€šä¿¡ï¼Œä»è€Œå®ç°æ¶ˆæ¯è½¬å‘ã€‚
- DevTools Page æ ¹æ®æ‹¿åˆ°çš„æ•°æ®ï¼Œæ¸²æŸ“ç»„ä»¶çš„ä¿¡æ¯ï¼Œå®ç°äº¤äº’åŠŸèƒ½ã€‚
![](assets/img/devTools_page_progress.png)
DevTools Page éƒ¨åˆ†æ¸²æŸ“å‡ºçš„ç•Œé¢æ˜¯è¿™æ ·çš„ï¼š
![](assets/img/vue_devtools_res.png)
React DevTools ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯é€šè¿‡ backend æ‹¿åˆ°ç»„ä»¶ä¿¡æ¯ï¼Œç„¶åä¼ é€’ç»™ DevTools Page åšæ¸²æŸ“å’Œäº¤äº’ã€‚
![](assets/img/react_developer_tools.png)

ä¸è¿‡ React DevTools è¿˜æœ‰ç‹¬ç«‹çš„ Electron åº”ç”¨ï¼Œå¯ä»¥ç”¨äº React Native çš„è°ƒè¯•ã€‚
![](assets/img/react_developer_tools_res.png)
è¿™ç§è‡ªå®šä¹‰è°ƒè¯•å·¥å…·ä¹Ÿæ˜¯ç”¨çš„ Chrome DevTools Protocol åè®®ä¹ˆï¼Ÿ
æ˜æ˜¾ä¸æ˜¯ï¼ŒCDP åè®®ç”¨æ¥è°ƒè¯• DOMã€JS ç­‰æŒºä¸é”™çš„ï¼Œä½†æ˜¯ä¸å¥½æ‰©å±•ï¼Œå¦‚æœæœ‰åˆ«çš„éœ€æ±‚ï¼Œä¸€èˆ¬éƒ½æ˜¯è‡ªå®šä¹‰è°ƒè¯•åè®®ã€‚

éƒ½æœ‰ backend éƒ¨åˆ†è´Ÿè´£æ‹¿åˆ°è¿è¡Œæ—¶çš„ä¿¡æ¯ï¼Œæœ‰ frontend éƒ¨åˆ†è´Ÿè´£æ¸²æŸ“å’Œäº¤äº’ï¼Œä¹Ÿæœ‰è°ƒè¯•åè®®ç”¨æ¥è§„å®šä¸åŒæ•°æ®çš„æ ¼å¼ï¼Œè¿˜æœ‰ä¸åŒçš„ä¿¡é“ï¼Œæ¯”å¦‚ WebSocket ã€Chrome æ’ä»¶çš„ background è½¬å‘ç­‰ã€‚

> frontendã€backendã€è°ƒè¯•åè®®ã€ä¿¡é“ï¼Œè¿™æ˜¯è°ƒè¯•å·¥å…·çš„å››è¦ç´ ã€‚

ä¸è¿‡ï¼Œä¸åŒçš„è°ƒè¯•å·¥å…·éƒ½ä¼šæœ‰ä¸åŒçš„è®¾è®¡ï¼Œæ¯”å¦‚ VSCode Debugger ä¸ºäº†è·¨è¯­è¨€å¤ç”¨ï¼Œå¤šäº†ä¸€å±‚ Debugger Adapterï¼ŒReact DevTools æœ‰ç‹¬ç«‹çš„ electron åº”ç”¨ï¼Œç”¨è‡ªå®šä¹‰è°ƒè¯•åè®®ï¼Œå¯ä»¥è°ƒè¯• React Native ä»£ç ã€‚

## è°ƒè¯•ç½‘é¡µçš„JS
ä»¥ React é¡¹ç›®ä¸ºä¾‹ï¼Œç”¨ create-react-app åˆ›å»ºä¸€ä¸ª react é¡¹ç›®ï¼š
```bash
$ yarn create react-app test-react-debug
```
è¿›å…¥é¡¹ç›®ç›®å½•ï¼Œæ‰§è¡Œ `yarn start`ã€‚

å®ƒä¼šå¯åŠ¨ä¸€ä¸ªå¼€å‘æœåŠ¡ï¼Œç„¶åæµè§ˆå™¨è®¿é—® localhost:3000ï¼š
![](assets/img/localhost3000.png)
æ‰“å¼€ Chrome DevToolsï¼Œåœ¨ Sources é¢æ¿æ‰¾åˆ° src/index.jsï¼Œæ‰“ä¸Šä¸ªæ–­ç‚¹ï¼š
![](assets/img/break_point.png)
ç„¶ååˆ·æ–°é¡µé¢å°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†ï¼š
![](assets/img/break_point_proceeding.png)

ä»£ç ä¼šåœ¨æ–­ç‚¹å¤„æ–­ä½ï¼Œå³è¾¹ä¼šæ˜¾ç¤ºå½“å‰ local ä½œç”¨åŸŸçš„å˜é‡ï¼Œglobal ä½œç”¨åŸŸçš„å˜é‡ï¼Œè¿˜æœ‰è°ƒç”¨æ ˆ call stackã€‚
![](assets/img/break_point_control.png)

ä¸Šé¢æœ‰å‡ ä¸ªæ§åˆ¶æ‰§è¡Œçš„æŒ‰é’®ï¼Œåˆ†åˆ«æ˜¯ï¼š
![](assets/img/resume_script_execution.png)æ¢å¤æ‰§è¡Œ

![](assets/img/step_over_next_function_call.png)å•æ­¥æ‰§è¡Œ

![](assets/img/step_into_next_function_call.png)è¿›å…¥å‡½æ•°è°ƒç”¨

![](assets/img/step_out_of_current_function.png)è·³å‡ºå‡½æ•°è°ƒç”¨

![](assets/img/step.png)ä»£ç æ‰§è¡Œä¸‹ä¸€æ­¥

![](assets/img/deactivate_breakpoint.png)è®©æ–­ç‚¹å¤±æ•ˆ

![](assets/img/catch_stop.png)åœ¨å¼‚å¸¸å¤„æ–­ä½

**å¯ä»¥æ§åˆ¶ä»£ç çš„æ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸€æ­¥çš„è°ƒç”¨æ ˆå’Œä½œç”¨åŸŸçš„å˜é‡ï¼Œé‚£ç†æ¸…ä»£ç çš„é€»è¾‘ï¼Œæˆ–è€…æ’æŸ¥ä»£ç ä¸­çš„é—®é¢˜ä¸å°±å¾ˆå®¹æ˜“äº†ä¹ˆï¼Ÿ**

å…¶å®è°ƒè¯•ç½‘é¡µçš„ JSï¼Œé™¤äº† Chrome DevTools å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ›´å¥½ç”¨çš„è°ƒè¯•æ–¹å¼ï¼š VSCode Debuggerã€‚

ç”¨ VSCode æ‰“å¼€é¡¹ç›®ç›®å½•ï¼Œåˆ›å»º .vscode/launch.json æ–‡ä»¶ï¼š

ç‚¹å‡»å³ä¸‹è§’çš„ Add Configuration(æ·»åŠ é…ç½®)... æŒ‰é’®ï¼Œé€‰æ‹© Chrome: Launch(Chrome: å¯åŠ¨)
![](assets/img/vscode_launch.png)

æŠŠè®¿é—®çš„ url æ”¹ä¸ºå¼€å‘æœåŠ¡å™¨å¯åŠ¨çš„åœ°å€ï¼š
```json
{
  "configurations": [
    {
      "name": "Launch Chrome",
      "request": "launch",
      "type": "chrome",
      // "url": "http://localhost:8080",
      "url": "http://localhost:3000",
      "webRoot": "${workspaceFolder}"
    }
  ]
}
```
ç„¶åè¿›å…¥ Debug çª—å£ï¼Œç‚¹å‡»å¯åŠ¨ï¼š
![](assets/img/vscode_launch_debug.png)
ä½ ä¼šå‘ç°å®ƒå¯åŠ¨äº†æµè§ˆå™¨ï¼Œå¹¶æ‰“å¼€äº†è¿™ä¸ª urlï¼š
![](assets/img/vscode_launch_debug_run.png)

åœ¨ä»£ç æ‰“ä¸ªæ–­ç‚¹ï¼Œç„¶åç‚¹å‡»![](assets/img/reboot.png)åˆ·æ–°ï¼š
![](assets/img/vscode_debug_break_point.png)

ä»£ç ä¼šæ‰§è¡Œåˆ°æ–­ç‚¹å¤„æ–­ä½ï¼Œæœ¬åœ°å’Œå…¨å±€ä½œç”¨åŸŸçš„å˜é‡ï¼Œè°ƒç”¨æ ˆç­‰éƒ½ä¼šå±•ç¤ºåœ¨å·¦è¾¹ï¼š
![](assets/img/vscode_debug_break_point_run.png)

ä¸Šé¢çš„æ§åˆ¶æŒ‰é’®åˆ†åˆ«å¯¹åº”æ¢å¤æ‰§è¡Œã€å•æ­¥æ‰§è¡Œã€è¿›å…¥å‡½æ•°è°ƒç”¨ã€è·³å‡ºå‡½æ•°è°ƒç”¨ï¼Œè¿™ä¸ªå’Œ Chrome DevTools ä¸€æ ·ï¼š

è¿˜å¤šäº†åˆ·æ–°å’Œåœæ­¢çš„æŒ‰é’®ã€‚

é‚£å¼‚å¸¸æ–­ç‚¹çš„æŒ‰é’®å‘¢ï¼Ÿ
![](assets/img/vscode_debug_break_point_run_error_stop.png)

å¯ä»¥åœ¨è¢« catch çš„å¼‚å¸¸å¤„æ–­ä½ï¼Œä¹Ÿå¯ä»¥åœ¨æ²¡æœ‰è¢« catch çš„å¼‚å¸¸å¤„æ–­ä½ã€‚

çœ‹èµ·æ¥å’Œ Chrome DevTools é‡Œè°ƒè¯•å·®ä¸å¤šå‘€ï¼Œåœ¨ VSCode Debugger é‡Œè°ƒè¯•æœ‰å•¥å¥½å¤„ä¹ˆï¼Ÿ

å¥½å¤„æ˜¯ä¸ç”¨åˆ‡æ¢å·¥å…·å‘€ï¼Œä¹‹å‰æ˜¯è°ƒè¯•åœ¨ Chrome DevToolsï¼Œå†™ä»£ç åœ¨ VSCodeï¼Œè€Œç°åœ¨å†™ä»£ç å’Œè°ƒè¯•éƒ½å¯ä»¥åœ¨ VSCode é‡Œï¼Œå¯ä»¥è¾¹è°ƒè¯•è¾¹å†™ä»£ç ã€‚

æ¯”å¦‚æˆ‘æƒ³è®¿é—® this çš„æŸä¸ªå±æ€§ï¼Œå¯ä»¥åœ¨ Debug Console é‡Œè¾“å…¥ this çœ‹ä¸‹å®ƒçš„å€¼ï¼Œç„¶åå†æ¥å†™ä»£ç ï¼š
![](assets/img/vscode_debug_this.png)

å¦‚æœä½ ç”¨äº† TypeScript å¯èƒ½ä¼šæœ‰å±æ€§åçš„æç¤ºã€å±æ€§å€¼ç±»å‹çš„æç¤ºï¼Œä½†å¹¶ä¸çŸ¥é“å±æ€§çš„å€¼æ˜¯å•¥ã€‚

è€Œè¾¹è°ƒè¯•è¾¹å†™ä»£ç ï¼Œèƒ½ç›´æ¥çŸ¥é“å±æ€§å€¼æ˜¯ä»€ä¹ˆï¼Œæœ‰å“ªäº›å‡½æ•°å¯ä»¥è°ƒç”¨ã€‚

> è¾¹è°ƒè¯•è¾¹å†™ä»£ç æ˜¯æ¨èçš„å†™ä»£ç æ–¹å¼ã€‚

çŸ¥é“äº†æ€ä¹ˆç”¨ï¼Œå†æ¥æ€è€ƒä¸‹ï¼šä¸ºä»€ä¹ˆ Chrome DevTools å’Œ VSCode Debugger éƒ½å¯ä»¥è°ƒè¯•ç½‘é¡µå‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºè°ƒè¯•åè®®æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ CDPã€‚Chrome DevTools å¯ä»¥å¯¹æ¥ CDP æ¥è°ƒè¯•ç½‘é¡µï¼ŒVSCode Debugger ä¹Ÿå¯ä»¥ã€‚åªä¸è¿‡ VSCode Debugger ä¼šå¤šä¸€å±‚ Debug Adapter Protocol çš„è½¬æ¢ã€‚
![](assets/img/vscode_and_chrome_debug.png)
è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸¤ä¸ªè°ƒè¯•å·¥å…·çš„åŠŸèƒ½å¤§åŒå°å¼‚ã€‚

### æ€»ç»“
Chrome DevTools å’Œ VSCode Debugger éƒ½èƒ½è°ƒè¯•ç½‘é¡µçš„ JSï¼Œå¯ä»¥æ‰“æ–­ç‚¹ï¼Œå•æ­¥æ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ°æœ¬åœ°å’Œå…¨å±€ä½œç”¨åŸŸçš„å˜é‡ï¼Œè¿˜æœ‰å‡½æ•°è°ƒç”¨æ ˆã€‚

ä½†æ›´æ¨èä½¿ç”¨ VSCode Debugger æ¥è°ƒè¯•ï¼Œè¿™æ ·å†™ä»£ç å’Œè°ƒè¯•éƒ½ç”¨åŒä¸€ä¸ªå·¥å…·ï¼Œä¸ç”¨åˆ‡æ¢ï¼Œè€Œä¸”è¿˜å¯ä»¥è¾¹è°ƒè¯•è¾¹å†™ä»£ç ã€‚

è¿™ä¸¤ä¸ªåŸç†éƒ½æ˜¯å¯¹æ¥äº† Chrome DevTools Protocolï¼Œç”¨è‡ªå·±çš„ UI æ¥åšå±•ç¤ºå’Œäº¤äº’ã€‚

## VSCode Chrome Debuggeré…ç½®è¯¦è§£

### launch/attach
åˆ›å»º Chrome Debug é…ç½®æœ‰ä¸¤ç§æ–¹å¼ï¼šlaunch å’Œ attachï¼š

å®ƒä»¬åªæ˜¯ request çš„é…ç½®ä¸åŒï¼š
```json
{
  "configurations": [
    {
      "name": "Attach to Chrome",
      "port": 9222,
      "request": "attach",
      "type": "chrome",
      "webRoot": "${workspaceFolder}"
    },
    {
      "name": "Launch Chrome",
      "request": "launch",
      "type": "chrome",
      // "url": "http://localhost:8080",
      "url": "http://localhost:3000",
      "webRoot": "${workspaceFolder}"
    }
  ]
}
```
æˆ‘ä»¬çŸ¥é“ï¼Œè°ƒè¯•å°±æ˜¯æŠŠæµè§ˆå™¨è·‘èµ·æ¥ï¼Œè®¿é—®ç›®æ ‡ç½‘é¡µï¼Œè¿™æ—¶å€™ä¼šæœ‰ä¸€ä¸ª ws çš„è°ƒè¯•æœåŠ¡ï¼Œæˆ‘ä»¬ç”¨ frontend çš„ ws å®¢æˆ·ç«¯è¿æ¥ä¸Šè¿™ä¸ª ws æœåŠ¡ï¼Œå°±å¯ä»¥è¿›è¡Œè°ƒè¯•äº†ã€‚

![](assets/img/chrome_devtools_principle.png)

VSCode çš„ Debugger ä¼šå¤šä¸€å±‚é€‚é…å™¨åè®®çš„è½¬æ¢ï¼Œä½†æ˜¯åŸç†å·®ä¸å¤šã€‚

launch çš„æ„æ€æ˜¯æŠŠ url å¯¹åº”çš„ç½‘é¡µè·‘èµ·æ¥ï¼ŒæŒ‡å®šè°ƒè¯•ç«¯å£ï¼Œç„¶å frontend è‡ªåŠ¨ attach åˆ°è¿™ä¸ªç«¯å£ã€‚

ä½†å¦‚æœä½ å·²ç»æœ‰ä¸€ä¸ªåœ¨è°ƒè¯•æ¨¡å¼è·‘çš„æµè§ˆå™¨äº†ï¼Œé‚£ç›´æ¥è¿æ¥ä¸Šå°±è¡Œï¼Œè¿™æ—¶å€™å°±ç›´æ¥ attachã€‚

æ¯”å¦‚æˆ‘ä»¬æ‰‹åŠ¨æŠŠ Chrome è·‘èµ·æ¥ï¼ŒæŒ‡å®šè°ƒè¯•ç«¯å£ remote-debugging-port ä¸º 9222ï¼ŒæŒ‡å®šç”¨æˆ·æ•°æ®ä¿å­˜ç›®å½• user-data-dir ä¸ºä½ è‡ªå·±åˆ›å»ºä¸€ä¸ªç›®å½•ã€‚

åœ¨å‘½ä»¤è¡Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š
```bash
# macos
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --remote-debugging-port=9222 --user-data-dir=ä½ è‡ªå·±åˆ›å»ºçš„æŸä¸ªç›®å½•

# window
# æ­¥éª¤ï¼š
# chromeå›¾æ ‡å³é”®å±æ€§-æ‰¾åˆ°ç›®æ ‡è·¯å¾„-å¤åˆ¶ç›®å½•
# æˆ‘çš„ç”µè„‘-å³é”®å±æ€§-é«˜çº§ç³»ç»Ÿè®¾ç½®-ç¯å¢ƒå˜é‡-æ‰¾åˆ°å˜é‡Path-æ–°å»º-å¡«å…¥ç¯å¢ƒå˜é‡ç›®å½•(æ³¨æ„æ˜¯ç›®å½•)
# æ‰“å¼€cmd-è¾“å…¥chrome.exeå³å¯æ‰“å¼€
chrome --remote-debugging-port=9222 --user-data-dir=D:\test
```

Chrome è·‘èµ·æ¥ä¹‹åï¼Œä½ å¯ä»¥æ‰“å¼€å‡ ä¸ªç½‘é¡µï¼Œæ¯”å¦‚ç™¾åº¦ã€æ˜é‡‘ï¼Œç„¶åä½ è®¿é—® localhost:9222/jsonï¼Œè¿™æ—¶å€™ä½ å°±ä¼šå‘ç°æ‰€æœ‰çš„ ws æœåŠ¡çš„åœ°å€äº†ï¼š
![](assets/img/localhost9222json.png)
ä¸ºä»€ä¹ˆæ¯ä¸ªé¡µé¢æœ‰å•ç‹¬çš„ ws æœåŠ¡å‘¢ï¼Ÿ

è¿™ä¸ªå¾ˆæ­£å¸¸å‘€ï¼Œæ¯ä¸ªé¡µé¢çš„è°ƒè¯•éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œè‡ªç„¶å°±éœ€è¦å•ç‹¬çš„ ws æœåŠ¡ã€‚

ç„¶åä½ åˆ›å»ºä¸€ä¸ª attach çš„ Chrome Debug é…ç½®ï¼š
```json
{
  "configurations": [
    {
      "name": "Attach to Chrome",
      "port": 9222,
      "request": "attach",
      "type": "chrome",
      "webRoot": "${workspaceFolder}"
    }
  ]
}
```
ç‚¹å‡»å¯åŠ¨ï¼Œå°±ä¼šçœ‹åˆ° VSCode Debugger å’Œæ¯ä¸€ä¸ªé¡µé¢çš„ ws è°ƒè¯•æœåŠ¡å»ºç«‹èµ·äº†é“¾æ¥ï¼š
![](assets/img/vscode_debugger_ws_console.png)
æ¯”å¦‚è®¿é—®(localhost:3000)ä¹‹å‰çš„ React é¡¹ç›®ï¼Œå°±å¯ä»¥è¿›è¡Œè°ƒè¯•äº†ï¼š
![](assets/img/vscode_debugger_ws_console_localhost3000.png)

å¯ä»¥å¤šä¸ªé¡µé¢ä¸€èµ·è°ƒè¯•ï¼Œæ¯ä¸ªé¡µé¢éƒ½æœ‰ç‹¬ç«‹çš„è°ƒè¯•ä¸Šä¸‹æ–‡ã€‚

### userDataDir
ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°åˆšæ‰æ‰‹åŠ¨å¯åŠ¨ Chrome çš„æ—¶å€™ï¼Œé™¤äº†æŒ‡å®šè°ƒè¯•ç«¯å£ remote-debugging-port å¤–ï¼Œè¿˜æŒ‡å®šäº†ç”¨æˆ·æ•°æ®ç›®å½• user-data-dirã€‚

ä¸ºä»€ä¹ˆè¦æŒ‡å®šè¿™ä¸ªå‘¢ï¼Ÿ

user data dir æ˜¯ä¿å­˜ç”¨æˆ·æ•°æ®çš„åœ°æ–¹ï¼Œæ¯”å¦‚ä½ çš„æµè§ˆè®°å½•ã€cookiesã€æ’ä»¶ã€ä¹¦ç­¾ã€ç½‘ç«™çš„æ•°æ®ç­‰ç­‰ï¼Œåœ¨ macOS ä¸‹æ˜¯ä¿å­˜åœ¨è¿™ä¸ªä½ç½®ï¼š
```bash
~/Library/Application\ Support/Google/Chrome
```
æ¯”å¦‚ä½ æ‰“å¼€ Default/Bookmarks çœ‹ä¸€ä¸‹ï¼Œæ˜¯ä¸æ˜¯éƒ½æ˜¯ä½ ä¿å­˜çš„ä¹¦ç­¾ï¼Ÿ
```bash
open ~/Library/Application\ Support/Google/Chrome/Default/Bookmarks
```
![](assets/img/macos_default_bookmarks.png)

**windows**

ä½ è¿˜å¯ä»¥åˆ æ‰ Default/Cookiesï¼Œä¹‹åå†è®¿é—®ä¹‹å‰ç™»é™†è¿‡çš„ç½‘ç«™è¯•ä¸€ä¸‹ï¼Œæ˜¯ä¸æ˜¯éƒ½éœ€è¦ç™»å½•äº†ï¼Ÿ

è¿™å°±æ˜¯ç”¨æˆ·æ•°æ®ç›®å½•çš„ä½œç”¨ã€‚

é‚£ä¸ºä»€ä¹ˆå¯åŠ¨ Chrome è¦æ‰‹åŠ¨æŒ‡å®šè¿™ä¸ªå‘¢ï¼Ÿéƒ½ç”¨é»˜è®¤çš„ä¸è¡Œä¹ˆï¼Ÿ

ç”¨æˆ·æ•°æ®ç›®å½•æœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯åªèƒ½è¢«ä¸€ä¸ª Chrome å®ä¾‹æ‰€è®¿é—®ï¼Œå¦‚æœä½ ä¹‹å‰å¯åŠ¨äº† Chrome ç”¨äº†è¿™ä¸ªé»˜è®¤çš„ user data dirï¼Œé‚£å°±ä¸èƒ½å†å¯åŠ¨ä¸€ä¸ª Chrome å®ä¾‹ç”¨å®ƒäº†ã€‚

å¦‚æœç”¨æˆ·æ•°æ®ç›®å½•å·²ç»è·‘äº†ä¸€ä¸ª Chrome å®ä¾‹ï¼Œå†è·‘ä¸€ä¸ªå€™ä¼šæŠ¥è¿™æ ·çš„é”™è¯¯ï¼š

macos
![](assets/img/unable_to_attach_to_browser.png)

windows
![](assets/img/unable_to_attach_to_browser_windows.png)

> å¦‚æœæŒ‡å®šäº†ä½ç½®å¯ä»¥å¼€å¯å¤šä¸ª
![](assets/img/unable_to_attach_to_browser_more.png)

æ‰€ä»¥ç”¨è°ƒè¯•æ¨¡å¼å¯åŠ¨ Chrome çš„æ—¶å€™ï¼Œéœ€è¦å•ç‹¬æŒ‡å®šä¸€ä¸‹ user data dir çš„ä½ç½®ã€‚æˆ–è€…ä½ ä¹ŸæŠŠä¹‹å‰çš„ Chrome å®ä¾‹å…³æ‰ï¼Œè¿™æ ·æ‰èƒ½ç”¨é»˜è®¤çš„ã€‚

launch çš„é…ç½®é¡¹é‡Œä¹Ÿæœ‰ userDataDir çš„é…ç½®ï¼š
![](assets/img/launch_userdatadir.png)

- **é»˜è®¤æ˜¯ true**ï¼Œä»£è¡¨åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥ä¿å­˜ç”¨æˆ·æ•°æ®ã€‚
  - æŠŠ userDataDir è®¾ç½®ä¸º true å°±æ¯æ¬¡éƒ½éœ€è¦ç™»å½•äº†ï¼š
- ä¹Ÿå¯ä»¥è®¾ç½®ä¸º falseï¼Œä½¿ç”¨é»˜è®¤ user data dir å¯åŠ¨ chromeã€‚
  - è¿™æ ·çš„å¥½å¤„å°±æ˜¯ç™»å½•çŠ¶æ€ã€å†å²è®°å½•å•¥çš„éƒ½æœ‰ï¼š

ä½ ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰çš„è·¯å¾„ï¼Œè¿™æ ·ç”¨æˆ·æ•°æ®å°±ä¼šä¿å­˜åœ¨é‚£ä¸ªç›®å½•ä¸‹ï¼š
```json
{
  "configurations": [
  {
    "name": "Launch Chrome",
    "request": "launch",
    "type": "chrome",
    "url": "http://localhost:8080",
    "userDataDir": "../../react-debug/test", // æŒ‡å®š
    "webRoot": "${workspaceFolder}"
  }
  ]
}
```
æ›´é‡è¦çš„æ˜¯ï¼Œä½ å®‰è£…çš„ React DevToolsã€Vue DevTools æ’ä»¶éƒ½æ˜¯åœ¨é»˜è®¤ç”¨æˆ·æ•°æ®ç›®å½•çš„ï¼Œè¦æ˜¯ç”¨ä¸´æ—¶æ•°æ®ç›®å½•è·‘è°ƒè¯•ï¼Œé‚£è¿™äº›ä¸éƒ½æ²¡äº†ï¼Ÿ

æ¯”å¦‚ä½  userDataDir è®¾ç½®ä¸º true çš„æ—¶å€™ï¼ŒReact DevTools æ’ä»¶æ˜¯æ²¡æœ‰çš„ï¼Œéœ€è¦å†å®‰è£…ï¼š
![](assets/img/no_react_devtools.png)
userDataDir è®¾ç½®ä¸º false çš„æ—¶å€™ï¼Œå®‰è£…è¿‡çš„æ’ä»¶éƒ½å¯ä»¥ç›´æ¥ç”¨ï¼š
![](assets/img/userdatadir_false.png)

ä½†æ˜¯é™¤äº†è°ƒè¯•ç”¨ä¹‹å¤–ï¼Œå¹³æ—¶ä¹Ÿä¼šç”¨åˆ° Chrome å‘€ï¼ŒåŒä¸€ä¸ª user data dir åªèƒ½è·‘ä¸€ä¸ª Chrome å®ä¾‹çš„è¯ï¼Œé‚£ä¸å°±å†²çªäº†ï¼Ÿ

è¿™ä¸ªé—®é¢˜å¯ä»¥ç”¨ä¸‹é¢çš„é…ç½®è§£å†³ï¼š

### runtimeExecutable
è°ƒè¯•ç½‘é¡µçš„ JSï¼Œéœ€è¦å…ˆæŠŠ Chrome è·‘èµ·æ¥ï¼Œé»˜è®¤è·‘çš„æ˜¯ Google Chromeï¼Œå…¶å®å®ƒè¿˜æœ‰å¦å¤–ä¸€ä¸ªç‰ˆæœ¬ Canaryï¼š

![](assets/img/google_chrome_canary.png)

è¿™æ˜¯ç»™å¼€å‘è€…ç”¨çš„æ¯æ—¥æ„å»ºç‰ˆï¼Œèƒ½å¤Ÿå¿«é€Ÿä½“éªŒæ–°ç‰¹æ€§ï¼Œä½†æ˜¯ä¸ç¨³å®šã€‚

è€Œ Google Chrome æ˜¯ç»™æ™®é€šç”¨æˆ·ç”¨çš„ï¼Œæ¯”è¾ƒç¨³å®šã€‚

è¿™ä¿©æ˜¯ç‹¬ç«‹çš„ï¼Œç›¸äº’ä¹‹é—´æ²¡å½±å“ï¼Œå¯ä»¥éƒ½ç”¨åŒä¸€ä¸ª user data dir æ¥å¯åŠ¨ã€‚

ä½ å¯ä»¥åœ¨å®˜ç½‘[å®˜ç½‘](https://www.google.com/intl/zh-CN/chrome/canary/)æŠŠ canary ä¸‹è½½ä¸‹æ¥ã€‚

ç„¶åæŒ‡å®š runtimeExecutable ä¸º canaryï¼Œä½¿ç”¨é»˜è®¤çš„ç”¨æˆ·æ•°æ®ç›®å½•å¯åŠ¨ï¼š
```json
{
  "configurations": [
    {
      "name": "Launch Chrome",
      "request": "launch",
      "type": "chrome",
      "runtimeExecutable": "canary",
      "url": "http://localhost:3000",
      "userDataDir": false,
      "webRoot": "${workspaceFolder}"
    }
  ]
}
```
è¿™æ ·ä½ å°±å¯ä»¥è°ƒè¯•ç”¨ canaryï¼Œå¹³æ—¶ç”¨ chrome äº†ï¼Œä¸¤è€…éƒ½æœ‰å„è‡ªçš„é»˜è®¤æ•°æ®ç›®å½•ã€‚

> æ³¨æ„ï¼Œä¸€å®šè¦å…ˆå®‰è£…äº† canaryï¼Œæ‰èƒ½æŒ‡å®š canary run

å½“ç„¶ï¼ŒruntimeExecutable è¿˜å¯ä»¥æŒ‡å®šç”¨åˆ«çš„æµè§ˆå™¨è·‘ï¼š
![](assets/img/runtime_executable_other.png)

- å¯ä»¥æ˜¯ stableï¼Œä¹Ÿå°±æ˜¯ç¨³å®šçš„ Google Chromeï¼Œ
- æˆ–è€… canaryï¼Œä¹Ÿå°±æ˜¯æ¯æ—¥æ„å»ºç‰ˆçš„ Google Chrome Canaryï¼Œ
- è¿˜å¯ä»¥æ˜¯ customï¼Œç„¶åç”¨ CHROME_PATH ç¯å¢ƒå˜é‡æŒ‡å®šæµè§ˆå™¨çš„åœ°å€ã€‚

ä¸è¿‡å¸¸ç”¨çš„è¿˜æ˜¯ Chrome å’Œ Canaryã€‚

### runtimeArgs

å¯åŠ¨ Chrome çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šå¯åŠ¨å‚æ•°ï¼Œæ¯”å¦‚æ¯æ¬¡æ‰“å¼€ç½‘é¡µéƒ½é»˜è®¤è°ƒèµ· Chrome DevToolsï¼Œå°±å¯ä»¥åŠ ä¸€ä¸ª --auto-open-devtools-for-tabs çš„å¯åŠ¨å‚æ•°ï¼š
```json
{
  "configurations": [
    {
      "name": "Launch Chrome",
      "request": "launch",
      "type": "chrome",
      "runtimeExecutable": "canary",
      "runtimeArgs": ["--auto-open-devtools-for-tabs"],
      "url": "http://localhost:3000",
      "userDataDir": false,
      "webRoot": "${workspaceFolder}"
    }
  ]
}
```
æ•ˆæœå°±æ˜¯è¿™æ ·çš„ï¼š
![](assets/img/canary_auto_open_devtools.png)

æƒ³è¦æ— ç—•æ¨¡å¼å¯åŠ¨ï¼Œä¹Ÿå°±æ˜¯ä¸åŠ è½½æ’ä»¶ï¼Œæ²¡æœ‰ç™»å½•çŠ¶æ€ï¼Œå°±å¯ä»¥åŠ ä¸€ä¸ª --incognito çš„å¯åŠ¨å‚æ•°ï¼š
```json
{
  "configurations": [
    {
      "name": "Launch Chrome",
      "request": "launch",
      "type": "chrome",
      "runtimeExecutable": "canary",
      "runtimeArgs": ["--incognito"],
      "url": "http://localhost:3000",
      "userDataDir": false,
      "webRoot": "${workspaceFolder}"
    }
  ]
}
```
è°ƒè¯•ç”¨çš„æµè§ˆå™¨å°±ä¼šä»¥æ— ç—•æ¨¡å¼å¯åŠ¨äº†
![](assets/img/canary_auto_incognito.png)

> å…¶å®è®¾ç½®çš„ userDataDir å°±æ˜¯æŒ‡å®šäº† --user-data-dir çš„å¯åŠ¨å‚æ•°ã€‚

## sourceMapPathOverrides
ä»£ç æ˜¯ç»è¿‡ç¼–è¯‘æ‰“åŒ…ç„¶ååœ¨æµè§ˆå™¨è¿è¡Œçš„ï¼Œæ¯”å¦‚è¿™æ ·ï¼š
![](assets/img/devtools_sources_bundle.png)

å´å¯ä»¥ç›´æ¥è°ƒè¯•æºç ï¼Œè¿™æ˜¯é€šè¿‡ sourcemap åšåˆ°çš„ã€‚

è°ƒè¯•å·¥å…·éƒ½æ”¯æŒ sourcemapï¼Œå¹¶ä¸”æ˜¯é»˜è®¤å¼€å¯çš„ï¼š
![](assets/img/source_mapped_from.png)

å½“ç„¶ä¹Ÿå¯ä»¥å…³æ‰:
Chrome DevTools é‡Œè¿™ä¹ˆå…³ï¼ˆmacos: command(win: ctrl) + shift + pï¼‰ï¼š
ç„¶åè¾“å…¥sourcemap
![](assets/img/disabled_javascript_sourcemap.png)

VSCode Debugger è¿™ä¹ˆå…³ï¼š
```json
{
  "configurations": [
    {
      "name": "Launch Chrome",
      "request": "launch",
      "type": "chrome",
      "runtimeExecutable": "canary",
      "url": "http://localhost:3000",
      "webRoot": "${workspaceFolder}",
      "sourceMaps": false, // this
    }
  ]
}
```
è¿™æ ·è°ƒè¯•çš„å°±æ˜¯ç¼–è¯‘åçš„ä»£ç äº†ï¼š

![](assets/img/vscode_debugger_bundle.png)

åœ¨å¼€å¯ sourcemap çš„æƒ…å†µä¸‹ï¼Œç”¨ Chrome DevTools å¯ä»¥çœ‹åˆ°ï¼Œæºæ–‡ä»¶çš„è·¯å¾„æ˜¯ /static/js/bundle.js
![](assets/img/local3000_static_js_bundle.png)

è¢« sourcemap åˆ°äº† D:\front-end\conosle\react-debug\src\App.js
![](assets/img/d_front-end_console_react-debug_src_app.png)

è€Œåœ¨ VSCode é‡Œï¼Œè¿™ä¸ªè·¯å¾„æ˜¯æœ‰å¯¹åº”çš„æ–‡ä»¶çš„ï¼Œæ‰€ä»¥å°±ä¼šæ‰“å¼€å¯¹åº”æ–‡ä»¶çš„ç¼–è¾‘å™¨ï¼Œè¿™æ ·å°±å¯ä»¥è¾¹è°ƒè¯•è¾¹ä¿®æ”¹ä»£ç ã€‚

ä½†æœ‰çš„æ—¶å€™ï¼Œsourcemap åˆ°çš„æ–‡ä»¶è·¯å¾„åœ¨æœ¬åœ°é‡Œæ‰¾ä¸åˆ°ï¼Œè¿™æ—¶å€™ä»£ç å°±åªè¯»äº†ï¼Œå› ä¸ºæ²¡æœ‰åœ°æ–¹ä¿å­˜ï¼š

![](assets/img/sourcemap_vue_readonly.png)

è¿™ç§æƒ…å†µå°±éœ€è¦å¯¹ sourcemap åˆ°çš„è·¯å¾„å†åšä¸€æ¬¡æ˜ å°„ï¼š

![](assets/img/sourcemap_path_overrides.png)

é€šè¿‡ sourceMapPathOverrides è¿™ä¸ªé…ç½®é¡¹ã€‚

é»˜è®¤æœ‰è¿™ä¹ˆä¸‰ä¸ªé…ç½®ï¼š
```json
{
  "configurations": [
    {
      "name": "Launch Chrome",
      "request": "launch",
      "type": "chrome",
      "runtimeExecutable": "canary",
      "runtimeArgs": ["--incognito"],
      "url": "http://localhost:3000",
      "userDataDir": false,
      "webRoot": "${workspaceFolder}",
      "sourceMapPathOverrides": { // this
        "meteor://ğŸ’»app/*": "${workspaceFolder}/*",
        "webpack:///./~/*": "${workspaceFolder}/node_modules/*",
        "webpack://?:*/*": "${workspaceFolder}/*"
      }
    }
  ]
}
```
åˆ†åˆ«æ˜¯æŠŠ meteorã€webpack å¼€å¤´çš„ path æ˜ å°„åˆ°äº†æœ¬åœ°çš„ç›®å½•ä¸‹ã€‚

å…¶ä¸­ ?:* ä»£è¡¨åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œä½†ä¸æ˜ å°„ï¼Œè€Œ * æ˜¯ç”¨äºåŒ¹é…å­—ç¬¦å¹¶æ˜ å°„çš„ã€‚

æ¯”å¦‚æœ€åä¸€ä¸ª webpack://?:*/* åˆ° ${workspaceFolder}/* çš„æ˜ å°„ï¼Œå°±æ˜¯æŠŠ webpack:// å¼€å¤´ï¼Œåé¢æ¥ä»»æ„å­—ç¬¦ + / ç„¶åæ˜¯ä»»æ„å­—ç¬¦çš„è·¯å¾„æ˜ å°„åˆ°äº†æœ¬åœ°çš„é¡¹ç›®ç›®å½•ã€‚ï¼ˆworkspaceFolder æ˜¯ä¸€ä¸ªå†…ç½®å˜é‡ï¼Œä»£è¡¨é¡¹ç›®æ ¹ç›®å½•ï¼‰

æŠŠè°ƒè¯•çš„æ–‡ä»¶ sourcemap åˆ°çš„è·¯å¾„æ˜ å°„åˆ°æœ¬åœ°çš„æ–‡ä»¶ï¼Œè¿™æ ·è°ƒè¯•çš„ä»£ç å°±ä¸å†åªè¯»äº†ï¼š

### file
é™¤äº†å¯åŠ¨å¼€å‘æœåŠ¡å™¨ç„¶åè¿ä¸Š url è°ƒè¯•ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šæŸä¸ªæ–‡ä»¶ï¼ŒVSCode Debugger ä¼šå¯åŠ¨é™æ€æœåŠ¡å™¨æä¾›æœåŠ¡ï¼š
```json
{
  "configurations": [
    {
      "name": "Launch Chrome",
      "request": "launch",
      "type": "chrome",
      "runtimeExecutable": "canary",
      "userDataDir": false,
      "webRoot": "${workspaceFolder}",
      "file": "${workspaceFolder}/index.html" // æŒ‡å®šæŸä¸ªæ–‡ä»¶
    }
  ]
}
```
index.html(æ”¾åœ¨é¡¹ç›®æ ¹(/)ç›®å½•ä¸‹) çš„å†…å®¹å¦‚ä¸‹ï¼š
![](assets/img/index_html.png)
æ‰“äº†ä¸ªæ–­ç‚¹ï¼Œç„¶åå¯åŠ¨è°ƒè¯•ï¼š
![](assets/img/vscode_debugger_index_html.png)
è¿™æ ·å°±å¯ä»¥ç›´æ¥è°ƒè¯•é™æ€ç½‘é¡µäº†ã€‚

åŒæ ·ï¼Œè¦ä¿®æ”¹è°ƒè¯•çš„å†…å®¹éœ€è¦æŠŠ url æ˜ å°„åˆ°æœ¬åœ°æ–‡ä»¶æ‰è¡Œï¼Œæ‰€ä»¥æœ‰è¿™æ ·ä¸€ä¸ª pathMapping çš„é…ç½®ï¼š
```json
{
  "configurations": [
    {
      "name": "Launch Chrome",
      "request": "launch",
      "type": "chrome",
      "runtimeExecutable": "canary",
      "runtimeArgs": ["--incognito"],
      "file": "${workspaceFolder}/index.html", // æŒ‡å®šæŸä¸ªæ–‡ä»¶
      "userDataDir": false,
      "webRoot": "${workspaceFolder}",
      "pathMapping": {
        "/static/js/": "${workspaceFolder}/src/"
      }
    }
  ]
}
```
webRoot å…¶å®å°±ç›¸å½“äºæŠŠ / çš„ url æ˜ å°„åˆ°äº† ${workspaceFolder}/ã€‚
è¿™äº›é…ç½®å€’æ˜¯å¾ˆå°‘ç”¨ï¼Œä¸€èˆ¬æˆ‘ä»¬è¿˜æ˜¯å¯åŠ¨ dev serverï¼Œå†è°ƒè¯•æŸä¸ª url æ›´å¤šä¸€äº›ã€‚

### æ€»ç»“
- launchï¼šè°ƒè¯•æ¨¡å¼å¯åŠ¨æµè§ˆå™¨ï¼Œè®¿é—®æŸä¸ª urlï¼Œç„¶åè¿ä¸Šè¿›è¡Œè°ƒè¯•
- attachï¼šè¿æ¥æŸä¸ªå·²ç»åœ¨è°ƒè¯•æ¨¡å¼å¯åŠ¨çš„ url è¿›è¡Œè°ƒè¯•
- userDataDirï¼š user data dir æ˜¯ä¿å­˜ç”¨æˆ·æ•°æ®çš„åœ°æ–¹ï¼Œæ¯”å¦‚æµè§ˆå†å²ã€cookie ç­‰ï¼Œä¸€ä¸ªæ•°æ®ç›®å½•åªèƒ½è·‘ä¸€ä¸ª chromeï¼Œæ‰€ä»¥é»˜è®¤ä¼šåˆ›å»ºä¸´æ—¶ç”¨æˆ·æ•°æ®ç›®å½•ï¼Œæƒ³ç”¨é»˜è®¤çš„ç›®å½•å¯ä»¥æŠŠè¿™ä¸ªé…ç½®è®¾ä¸º false
- runtimeExecutableï¼šåˆ‡æ¢è°ƒè¯•ç”¨çš„æµè§ˆå™¨ï¼Œå¯ä»¥æ˜¯ stableã€canary æˆ–è€…è‡ªå®šä¹‰çš„
- runtimeArgsï¼šå¯åŠ¨æµè§ˆå™¨çš„æ—¶å€™ä¼ é€’çš„å¯åŠ¨å‚æ•°
- sourceMapPathOverridesï¼šå¯¹ sourcemap åˆ°çš„æ–‡ä»¶è·¯å¾„åšä¸€æ¬¡æ˜ å°„ï¼Œæ˜ å°„åˆ° VSCode - workspace ä¸‹çš„æ–‡ä»¶ï¼Œè¿™æ ·è°ƒè¯•çš„æ–‡ä»¶å°±å¯ä»¥ä¿®æ”¹äº†
- fileï¼šå¯ä»¥ç›´æ¥æŒ‡å®šæŸä¸ªæ–‡ä»¶ï¼Œç„¶åå¯åŠ¨è°ƒè¯•


## sourcemapçš„åŸç†å’Œä½œç”¨
### ä»€ä¹ˆæ˜¯ sourcemap
> sourcemap æ˜¯å…³è”ç¼–è¯‘åçš„ä»£ç å’Œæºç çš„ï¼Œé€šè¿‡ä¸€ä¸ªä¸ªè¡Œåˆ—å·çš„æ˜ å°„ã€‚

æ¯”å¦‚ç¼–è¯‘åä»£ç çš„ç¬¬ 3 è¡Œç¬¬ 4 åˆ—ï¼Œå¯¹åº”ç€æºç é‡Œçš„ç¬¬ 8 è¡Œç¬¬ 5 åˆ—è¿™ç§ï¼Œè¿™å«åšä¸€ä¸ª mappingã€‚
```js
{
  version : 3,
  file: "out.js",
  sourceRoot : "",
  sources: ["foo.js", "bar.js"],
  names: ["a", "b"],
  mappings: "AAgBC,SAAQ,CAAEA;AAAEA",
  sourcesContent: ['const a = 1; console.log(a)', 'const b = 2; console.log(b)']
}
```
- versionï¼šsourcemap çš„ç‰ˆæœ¬ï¼Œä¸€èˆ¬ä¸º 3
- fileï¼šç¼–è¯‘åçš„æ–‡ä»¶å
- sourceRootï¼šæºç æ ¹ç›®å½•
- namesï¼šè½¬æ¢å‰çš„å˜é‡å
- sourcesï¼šæºç æ–‡ä»¶å
- sourcesContentï¼šæ¯ä¸ª sources å¯¹åº”çš„æºç çš„å†…å®¹
- mappingsï¼šä¸€ä¸ªä¸ªä½ç½®æ˜ å°„

ä¸ºä»€ä¹ˆ sources å¯ä»¥æœ‰å¤šä¸ªå‘¢ï¼Ÿ

å› ä¸ºå¯èƒ½ç¼–è¯‘äº§ç‰©æ˜¯å¤šä¸ªæºæ–‡ä»¶åˆå¹¶çš„ï¼Œæ¯”å¦‚æ‰“åŒ…ï¼Œä¸€ä¸ª bundle.js å°±å¯¹åº”äº† n ä¸ª sources æºæ–‡ä»¶ã€‚

é‡ç‚¹æ˜¯ mappings éƒ¨åˆ†ï¼š

mappings éƒ¨åˆ†æ˜¯é€šè¿‡`åˆ†å·;` å’Œ`é€—å· ,` åˆ†éš”çš„ï¼š
```js
mappings:"AAAAA,BBBBB;CCCCC"
```
ä¸€ä¸ªåˆ†å·å°±ä»£è¡¨ä¸€è¡Œï¼Œè¿™æ ·å°±å…å»äº†è¡Œçš„æ˜ å°„ï¼›ç„¶åæ¯ä¸€è¡Œå¯èƒ½æœ‰å¤šä¸ªä½ç½®çš„æ˜ å°„ï¼Œç”¨` , `åˆ†éš”ã€‚

é‚£å…·ä½“çš„æ¯ä¸€ä¸ª mapping éƒ½æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

æ¯”å¦‚ AAAAA ä¸€å…±äº”ä½ï¼Œåˆ†åˆ«æœ‰ä¸åŒçš„å«ä¹‰ï¼š
- è½¬æ¢åä»£ç çš„ç¬¬å‡ åˆ—ï¼ˆè¡Œæ•°é€šè¿‡åˆ†å· ; æ¥ç¡®å®šï¼‰
- è½¬æ¢å‰çš„å“ªä¸ªæºç æ–‡ä»¶ï¼Œä¿å­˜åœ¨ sources é‡Œçš„ï¼Œè¿™é‡Œé€šè¿‡ä¸‹æ ‡ç´¢å¼•
- è½¬æ¢å‰çš„æºç çš„ç¬¬å‡ è¡Œ
- è½¬æ¢å‰çš„æºç çš„ç¬¬å‡ åˆ—
- è½¬æ¢å‰çš„æºç çš„å“ªä¸ªå˜é‡åï¼Œä¿å­˜åœ¨ names é‡Œçš„ï¼Œè¿™é‡Œé€šè¿‡ä¸‹æ ‡ç´¢å¼•

ç„¶åç»è¿‡ç¼–ç ä¹‹åï¼Œå°±æˆäº† AAAAA è¿™ç§ï¼Œè¿™ç§ç¼–ç æ–¹å¼å«åš VLQ ç¼–ç ã€‚

sourcemap çš„æ ¼å¼è¿˜æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼Œå°±æ˜¯ä¸€ä¸€æ˜ å°„ç¼–è¯‘åä»£ç çš„ä½ç½®å’Œæºç çš„ä½ç½®ã€‚

å„ç§è°ƒè¯•å·¥å…·ä¸€èˆ¬éƒ½æ”¯æŒ sourcemap çš„è§£æï¼Œåªè¦åœ¨æ–‡ä»¶æœ«å°¾åŠ ä¸Šè¿™æ ·ä¸€è¡Œï¼š
```js
//# sourceMappingURL=/path/to/source.js.map
```
è¿è¡Œæ—¶å°±ä¼šå…³è”åˆ°æºç ï¼š
![](assets/img/sourcemap_run.png)

é™¤äº†è°ƒè¯•çš„æ—¶å€™ä¼šä½¿ç”¨ sourcemapï¼Œçº¿ä¸ŠæŠ¥é”™å®šä½æºç ä¹Ÿéœ€è¦ç”¨åˆ°ï¼š

å¼€å‘æ—¶ä¼šä½¿ç”¨ sourcemap æ¥è°ƒè¯•ï¼Œä½†æ˜¯ç”Ÿäº§å¯ä¸ä¼šï¼Œä½†æ˜¯çº¿ä¸ŠæŠ¥é”™çš„æ—¶å€™ç¡®å®ä¹Ÿéœ€è¦å®šä½åˆ°æºç ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬éƒ½æ˜¯å•ç‹¬ä¸Šä¼  sourcemap åˆ°é”™è¯¯æ”¶é›†å¹³å°ã€‚

æ¯”å¦‚ sentry å°±æä¾›äº†ä¸€ä¸ª [@sentry/webpack-plugin](https://www.npmjs.com/package/@sentry/webpack-plugin) æ”¯æŒåœ¨æ‰“åŒ…å®ŒæˆåæŠŠ sourcemap è‡ªåŠ¨ä¸Šä¼ åˆ° sentry åå°ï¼Œç„¶åæŠŠæœ¬åœ° sourcemap åˆ æ‰ã€‚è¿˜æä¾›äº† [@sentry/cli](https://www.npmjs.com/package/@sentry/cli) è®©ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ä¸Šä¼ ã€‚

å¹³æ—¶æˆ‘ä»¬è‡³å°‘åœ¨è¿™ä¸¤ä¸ªåœºæ™¯ï¼ˆ**å¼€å‘æ—¶è°ƒè¯•æºç ï¼Œç”Ÿäº§æ—¶å®šä½é”™è¯¯çš„æºç ä½ç½®**ï¼‰ä¸‹ä¼šç”¨åˆ° sourcemapã€‚

sourcemap åªæ˜¯ä½ç½®çš„æ˜ å°„ï¼Œå¯ä»¥ç”¨åœ¨ä»»ä½•ä»£ç ä¸Šï¼Œæ¯”å¦‚ JSã€TSã€CSS ç­‰ï¼Œè€Œä¸” TS çš„ç±»å‹ä¹Ÿæ”¯æŒ sourcemapï¼š
```js
// tsconfig.json
{
  "compilerOptions": {
    "outDir": "dist",
    "declaration": true, // æŒ‡å®šäº† declaration ä¼šç”Ÿæˆ d.ts çš„å£°æ˜æ–‡ä»¶
    "declarationMap": true // æŒ‡å®šäº† declarationMap æ¥ç”Ÿæˆ sourcemapï¼š
  },
  "include": ["src/**/*.ts"],
}
```
æ“ä½œæ­¥éª¤ï¼š
1. å®‰è£…
```bash
npm init -y
npm i -D typescript @type/typescript
tsc --init #ç”Ÿæˆtsconfig
```
ä¿®æ”¹tsconfig.jsoné…ç½®å¦‚ä¸Š,æ–°å»ºæ–‡ä»¶src/index.ts
```ts
interface Person {
  name: string;
  age: number;
}
const person: Person = {
  name: 'ming',
  age: 11
}
```
è¿è¡Œçœ‹ç»“æœï¼š
```bash
tsc
```

è¿™æ ·åœ¨ VSCode é‡Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ç‚¹å‡»æŸä¸ªç±»å‹æ¥è·³è½¬åˆ°æºç é‡Œå¯¹åº”çš„åœ°æ–¹äº†ã€‚

è¿™ä¹Ÿç®— sourcemap åº”ç”¨çš„å¦ä¸€ä¸ªåœºæ™¯ï¼Œç”¨äº**ç”Ÿæˆçš„ç±»å‹å’Œæºç ä¸­å®šä¹‰çš„å…³è”**ã€‚

### sourcemap çš„ç”Ÿæˆ
ç¼–è¯‘å·¥å…·åœ¨ç”Ÿæˆä»£ç çš„æ—¶å€™ä¹Ÿä¼šç”Ÿæˆ sourcemapï¼š
![](assets/img/sourcemap_create.png)

å…¶å® sourcemap å°±æ˜¯ç”±ä¸€ä¸ªä¸ªä½ç½®çš„æ˜ å°„ç»„æˆçš„ï¼Œå…³é”®å°±æ˜¯è¦çŸ¥é“æºç çš„å“ªä¸ªä½ç½®å¯¹åº”åˆ°äº†ç¼–è¯‘åä»£ç çš„å“ªä¸ªä½ç½®ï¼š

é€šè¿‡ [astexplorer.net](https://astexplorer.net/#/gist/19042bfa06784d0e1b2dcb2ecd3559d5/50898c658d8129dbe520cc515af169331082036b) å¯ä»¥çœ‹åˆ°ï¼ŒAST ä¸­ä¿ç•™äº†æºç ä¸­çš„ä½ç½®ï¼Œè¿™æ˜¯ parser åœ¨ parse æºç çš„æ—¶å€™è®°å½•çš„ã€‚

![](assets/img/ast_explorer.png)

ç„¶åè¿›è¡Œ AST çš„å„ç§è½¬æ¢ä¹‹åä¼šæ‰“å°æˆç›®æ ‡ä»£ç ï¼Œæ‰“å°çš„æ—¶å€™æ˜¯ä¸€è¡Œè¡Œä¸€åˆ—åˆ—çš„æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œè¿™æ—¶å€™å°±æœ‰äº†ç›®æ ‡ä»£ç ä¸­çš„ä½ç½®ã€‚
```js
export function ConditionalExpression(node: Object) {
  this.print(node.test, node);
  this.space();
  this.token("?");
  this.space();
  this.print(node.consequent, node);
  this.space();
  this.token(":");
  this.space();
  this.print(node.alternate, node);
}
```
è¿™ä¸¤ä¸ªä½ç½®ä¸€å…³è”ï¼Œé‚£ä¸å°±æ˜¯ä¸€ä¸ª mapping ä¹ˆï¼Ÿ

![](assets/img/sourcemap_correlation.png)

è¿™æ ·å°±ç”Ÿæˆäº† sourcemapã€‚

å½“ç„¶ sourcemap æœ‰å¯¹åº”çš„æ ¼å¼å’Œç¼–ç ï¼Œè‡ªå·±ç”Ÿæˆè¿˜æ˜¯æŒºéº»çƒ¦çš„ï¼Œæˆ‘ä»¬ä¼šç”¨ [source-map](https://www.npmjs.com/package/source-map) è¿™ä¸ªåŒ…ï¼š

source-map å¯ä»¥ç”¨äºç”Ÿæˆå’Œè§£æ sourcemapï¼Œå®ƒæš´éœ²äº† SourceMapConsumerã€SourceMapGeneratorã€SourceNode 3ä¸ªç±»ï¼Œåˆ†åˆ«ç”¨äºæ¶ˆè´¹ sourcemapã€ç”Ÿæˆ sourcemapã€åˆ›å»ºæºç èŠ‚ç‚¹ã€‚

ç”Ÿæˆ sourcemap çš„æµç¨‹æ˜¯ï¼š
1. åˆ›å»ºä¸€ä¸ª SourceMapGenerator å¯¹è±¡
2. é€šè¿‡ addMapping æ–¹æ³•æ·»åŠ ä¸€ä¸ªæ˜ å°„
3. é€šè¿‡ toString è½¬ä¸º sourcemap å­—ç¬¦ä¸²

```js
const { SourceMapGenerator } = require('source-map');

const map = new SourceMapGenerator({
    file: "source-mapped.js"
});
  
map.addMapping({
    generated: {
        line: 10,
        column: 35
    },
    source: "foo.js",
    original: {
        line: 33,
        column: 2
    },
    name: "christopher"
});
  
console.log(map.toString());
```
æ“ä½œï¼š
```bash
npm init -y
npm i -D source-map
```
æ–°å»ºä¸€ä¸ª`index.js`æ–‡ä»¶æ·»åŠ ä¸Šé¢ä»£ç 

![](assets/img/source-map_test.png)

æ¶ˆè´¹ sourcemap ç”¨ SourceMapConsumer çš„ apiã€‚

å¯ä»¥è°ƒç”¨ originalPositionFor å’Œ generatedPositionFor åˆ†åˆ«ç”¨ç›®æ ‡ä»£ç ä½ç½®æŸ¥æºç ä½ç½®å’Œç”¨æºç ä½ç½®æŸ¥ç›®æ ‡ä»£ç ä½ç½®

è¿˜å¯ä»¥é€šè¿‡ eachMapping éå†æ‰€æœ‰ mappingï¼Œå¯¹æ¯ä¸ªè¿›è¡Œå¤„ç†ã€‚

```js
const { SourceMapConsumer } = require('source-map');

const rawSourceMap = {
    version: 3,
    file: "min.js",
    names: ["bar", "baz", "n"],
    sources: ["one.js", "two.js"],
    sourceRoot: "http://example.com/www/js/",
    mappings: "CAAC,IAAI,IAAM,SAAUA,GAClB,OAAOC,IAAID;CCDb,IAAI,IAAM,SAAUE,GAClB,OAAOA"
};

(async function() {
    await SourceMapConsumer.with(rawSourceMap, null, consumer => {
        // ç›®æ ‡ä»£ç ä½ç½®æŸ¥è¯¢æºç ä½ç½®
        consumer.originalPositionFor({
            line: 2,
            column: 28
        })
        // { source: 'http://example.com/www/js/two.js',
        //   line: 2,
        //   column: 10,
        //   name: 'n' }
    
        // æºç ä½ç½®æŸ¥è¯¢ç›®æ ‡ä»£ç ä½ç½®
        consumer.generatedPositionFor({
            source: "http://example.com/www/js/two.js",
            line: 2,
            column: 10
        })
        // { line: 2, column: 28 }
    
        // éå† mapping
        consumer.eachMapping(function(m) {
            console.log(m);
        });    
    });
})();
```

åœ¨ä¸Šä¸€ä¸ªé¡¹ç›®æ·»åŠ `index2.js`,ä»£ç å¦‚ä¸Š

![](assets/img/source-map_test2.png)

çŸ¥é“äº†ä½ç½®ä»å“ªé‡Œæ¥ï¼ŒçŸ¥é“äº†æ€ä¹ˆç”¨ source-map çš„åŒ…ç”Ÿæˆ sourcemapï¼Œé‚£å°±çŸ¥é“äº†å¹³æ—¶æˆ‘ä»¬ç”¨çš„ sourcemap æ˜¯æ€ä¹ˆæ¥çš„äº†ã€‚

æ›´è¯¦ç»†çš„ä»‹ç»å¯ä»¥çœ‹ source-map è¿™ä¸ªåŒ…çš„[æ–‡æ¡£](https://www.npmjs.com/package/source-map#consuming-a-source-map)

### æ€»ç»“
sourcemapï¼Œå®ƒæ˜¯é€šè¿‡ä¸€ä¸ªä¸ªè¡Œåˆ—å·çš„æ˜ å°„æ¥å…³è”ç¼–è¯‘åçš„ä»£ç å’Œæºç çš„ã€‚
- è°ƒè¯•çš„æ—¶å€™ä¼šä½¿ç”¨ sourcemapï¼Œè¿™æ ·å¯ä»¥ç›´æ¥åœ¨æºç æ‰“æ–­ç‚¹è°ƒè¯•ã€‚
- çº¿ä¸ŠæŠ¥é”™çš„æ—¶å€™ä¼šä½¿ç”¨ sourcemap æ¥æ˜ å°„åˆ°æºç ï¼Œæˆ‘ä»¬ä¼šæŠŠ sourcemap å•ç‹¬ä¸Šä¼  sentry ç­‰é”™è¯¯æ”¶é›†å¹³å°ã€‚
- ç”Ÿæˆçš„ç±»å‹ä¹Ÿå¯ä»¥é€šè¿‡ sourcemap å…³è”åˆ°å¯¹åº”çš„æºç ä¸­çš„å®šä¹‰

å®ƒçš„ç”Ÿæˆå¯ä»¥é€šè¿‡ source-map åŒ…çš„ apiï¼Œè€Œ mapping çš„ä½ç½®æ¥æºå¯èƒ½æ˜¯æºç  parse åçš„ AST ä¸­çš„ä½ç½®ä¿¡æ¯å’Œæ‰“å°ä»£ç æ—¶è®¡ç®—å‡ºçš„ä½ç½®ä¿¡æ¯çš„å…³è”ã€‚

ç†è§£äº† sourcemap çš„ä½œç”¨ï¼Œå°±çŸ¥é“ä¸ºä»€ä¹ˆè°ƒè¯•ç¦»ä¸å¼€ sourcemap äº†ã€‚

> [JavaScript Source Map è¯¦è§£ â€”â€” é˜®ä¸€å³°](https://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html)

## webpackçš„sourcemapé…ç½®
webpack å¯¹ sourcemap åšäº†å¾ˆå¤šå°è£…ã€‚

webpack çš„ sourcemap é…ç½®æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œæ¯”å¦‚è¿™ä¸¤ä¸ªé…ç½®çš„åŒºåˆ«ï¼š
- eval-nosources-cheap-module-source-map
- hidden-source-map
æ˜¯ä¸æ˜¯åˆ†ä¸æ¸…æ¥šï¼Ÿä½ æŠŠé…ç½®å†™é”™çš„æ—¶å€™ï¼Œwebpack ä¼šæç¤ºä½ ä¸€ä¸ªæ­£åˆ™ï¼š
![](assets/img/webpack_sourcemap_hint.png)
`^(inline-|hidden-|eval-)?(nosources-)?(cheap-(module-)?)?source-map$`

### eval
eval çš„ api æ˜¯åŠ¨æ€æ‰§è¡Œ JS ä»£ç çš„ã€‚æ¯”å¦‚ï¼š
```js
eval(`function add(a, b) {
  return a + b;
}
console.log(add(1, 2));`);
// 3
```
æœ‰ä¸ªé—®é¢˜ï¼Œeval çš„ä»£ç æ‰“ä¸äº†æ–­ç‚¹ã€‚

æµè§ˆå™¨æ”¯æŒäº†è¿™æ ·ä¸€ç§ç‰¹æ€§ï¼Œåªè¦åœ¨ eval ä»£ç çš„æœ€ååŠ ä¸Š `//# sourceURL=xxx`ï¼Œé‚£å°±ä¼šä»¥ xxx ä¸ºåå­—æŠŠè¿™æ®µä»£ç åŠ åˆ° sources é‡Œã€‚é‚£ä¸å°±å¯ä»¥æ‰“æ–­ç‚¹äº†ä¹ˆï¼Ÿ
```js
eval(`function add(a, b) {
  return a + b;
}
console.log(add(1, 2));
//# sourceURL=ming.js`);
// 3
```

**é”™è¯¯æ“ä½œ**
- æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œé€‰æ‹©Console(æ§åˆ¶å°)
- è¾“å…¥ä¸Šè¿°ä»£ç 
- è¿è¡Œåå‡ºé”™çš„è¯
  - eval()ã€Function()ç­‰å‡½æ•°ä¼šä»å­—ç¬¦ä¸²ä¸­â€œè§£æâ€è„šæœ¬ä»£ç ï¼Œå¿…é¡»åœ¨å†…å®¹å®‰å…¨ç­–ç•¥ä¸­æ·»åŠ ä¿¡ä»»å­—ç¬¦ä¸²æ¥æºçš„è„šæœ¬çš„ç­–ç•¥æŒ‡ä»¤ï¼Œè¯¥æ¥æºçš„è„šæœ¬æ‰å¯ä»¥æ­£å¸¸è¿è¡Œã€‚
```bash
VM74:1 Uncaught EvalError: Refused to evaluate a string as JavaScript because 'unsafe-eval' is not an allowed source of script in the following Content Security Policy directive: "script-src 'self' blob: filesystem:".
    at <anonymous>:1:1
```
[å‚è€ƒæ–‡ç« ](https://blog.csdn.net/gao_zhennan/article/details/126006827)

**æ­£ç¡®æ“ä½œ**
> éœ€è¦åœ¨æ— å®‰å…¨ç­–ç•¥ä¸‹æ‰å¯ä»¥æ‰§è¡Œï¼Œå³å¼€å‘ç¯å¢ƒä¸‹
```html
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>
    console.log(window);
  </script>
</body>
</html>
```
è®¿é—®localhost:3000ï¼Œæ‰§è¡Œä»¥åï¼Œä¼šå‘ç° sources å¤šäº†`ming.js`çš„æ–‡ä»¶ï¼š

![](assets/img/eval_sourcemap.png)

å®ƒæ˜¯å¯ä»¥æ‰“æ–­ç‚¹çš„ï¼Œæ¯”å¦‚åœ¨ add é‡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œç„¶åå†åˆ‡æ¢åˆ°consoleæ‰§è¡Œ evalã€‚

![](assets/img/eval_sroucemap_breakpoint.png)

é™¤äº†æŒ‡å®š source æ–‡ä»¶å¤–ï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥æŒ‡å®š sourcemap æ¥æ˜ å°„åˆ°æºç ï¼š
```js
eval(`function add(a, b) {
  return a + b;
}
console.log(add(1, 2));
//# sourceURL=ming.js
//# sourceMappingURL=XXX
`);
// 3
```
è¿™æ ·ï¼ŒåŠ¨æ€ eval çš„ä»£ç ä¹Ÿèƒ½å…³è”åˆ°æºç ï¼Œå¹¶ä¸”èƒ½æ‰“æ–­ç‚¹äº†ï¼

webpack å°±åˆ©ç”¨äº† eval è¿™ä¸ªç‰¹æ€§æ¥ä¼˜åŒ–çš„ sourcemap ç”Ÿæˆçš„æ€§èƒ½ï¼Œæ¯”å¦‚ä½ å¯ä»¥æŒ‡å®š devtool ä¸º evalï¼š
```js
module.exports = {
  entry: './src/index.js',
  devtool: 'eval', // ç‰¹æ€§
  mode: 'development',
  // ...
}
```
ç”Ÿæˆçš„ä»£ç å°±æ˜¯æ¯ä¸ªæ¨¡å—éƒ½è¢« eval åŒ…è£¹çš„ï¼Œå¹¶ä¸”æœ‰ sourceUrl æ¥æŒ‡å®šæ–‡ä»¶åï¼š

![](assets/img/webpack_sroucemap_eval.png)

è¿™æ ·æœ‰å•¥å¥½å¤„å‘¢ï¼Ÿ

å¿«å‘€ï¼Œå› ä¸ºåªè¦æŒ‡å®šä¸ªæ–‡ä»¶åå°±è¡Œï¼Œä¸ç”¨ç”Ÿæˆ sourcemapã€‚sourcemap çš„ç”Ÿæˆè¿˜æ˜¯å¾ˆæ…¢çš„ï¼Œè¦ä¸€ä¸ªä¸ª mapping çš„å¤„ç†ï¼Œåšç¼–ç ä¹‹ç±»çš„ã€‚

æ¯ä¸ªæ¨¡å—çš„ä»£ç éƒ½è¢« eval åŒ…è£¹ï¼Œé‚£ä¹ˆæ‰§è¡Œçš„æ—¶å€™å°±ä¼šåœ¨ sources é‡Œç”Ÿæˆå¯¹åº”çš„æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥æ‰“æ–­ç‚¹äº†ï¼š

ä¸è¿‡è¿™æ ·åªæ˜¯æŠŠæ¯ä¸ªæ¨¡å—çš„ä»£ç åˆ†äº†å‡ºå»ï¼Œå¹¶æ²¡æœ‰åšæºç çš„å…³è”ï¼Œå¦‚æœç›¸å…³è”æºç ï¼Œå¯ä»¥å†å¼€å¯ sourcemapï¼š
```js
module.exports = {
  entry: './src/index.js',
  devtool: 'eval-source-map', // ç‰¹æ€§
  mode: 'development',
  // ...
}
```
ä½ ä¼šå‘ç°ç”Ÿæˆçš„ä»£ç ä¹Ÿæ˜¯ç”¨ eval åŒ…è£¹çš„ï¼Œä½†é™¤äº† sourceUrl å¤–ï¼Œè¿˜æœ‰ sourceMappingUrlï¼š
```js
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var react__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! react */ \"./node_modules/react/index.js\");\n/* harmony import */ var react__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(react__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var react_dom_client__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! react-dom/client */ \"./node_modules/react-dom/client.js\");\n\n\nfunction Aaa() {\n  debugger;\n  return /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_0___default().createElement(\"div\", null, \"111\");\n}\nconst container = document.getElementById('root');\nconst root = react_dom_client__WEBPACK_IMPORTED_MODULE_1__.createRoot(container);\nroot.render( /*#__PURE__*/react__WEBPACK_IMPORTED_MODULE_0___default().createElement(Aaa));//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiLi9zcmMvaW5kZXguanMiLCJtYXBwaW5ncyI6Ijs7OztBQUEwQjtBQUNjO0FBRXhDLFNBQVNFLEdBQUdBLENBQUEsRUFBRztFQUNYO0VBQ0Esb0JBQU9GLDBEQUFBLGNBQUssS0FBUSxDQUFDO0FBQ3pCO0FBRUEsTUFBTUksU0FBUyxHQUFHQyxRQUFRLENBQUNDLGNBQWMsQ0FBQyxNQUFNLENBQUM7QUFFakQsTUFBTUMsSUFBSSxHQUFHTix3REFBbUIsQ0FBQ0csU0FBUyxDQUFDO0FBQzNDRyxJQUFJLENBQUNFLE1BQU0sZUFBQ1QsMERBQW1CLENBQUNFLEdBQUcsQ0FBQyxDQUFDIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vd2VicGFjay10ZXN0Ly4vc3JjL2luZGV4LmpzP2I2MzUiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCBSZWFjdERPTSBmcm9tICdyZWFjdC1kb20vY2xpZW50JztcblxuZnVuY3Rpb24gQWFhKCkge1xuICAgIGRlYnVnZ2VyO1xuICAgIHJldHVybiA8ZGl2PjExMTwvZGl2PlxufVxuXG5jb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncm9vdCcpO1xuXG5jb25zdCByb290ID0gUmVhY3RET00uY3JlYXRlUm9vdChjb250YWluZXIpO1xucm9vdC5yZW5kZXIoUmVhY3QuY3JlYXRlRWxlbWVudChBYWEpKTsiXSwibmFtZXMiOlsiUmVhY3QiLCJSZWFjdERPTSIsIkFhYSIsImNyZWF0ZUVsZW1lbnQiLCJjb250YWluZXIiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwicm9vdCIsImNyZWF0ZVJvb3QiLCJyZW5kZXIiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///./src/index.js\n");
```
å†è¿è¡Œçš„æ—¶å€™é™¤äº† eval çš„ä»£ç ä¼šç”Ÿæˆæ–‡ä»¶æ”¾åœ¨ sources å¤–ï¼Œè¿˜ä¼šåš sourcemap çš„æ˜ å°„ï¼š

![](assets/img/webpack_sroucemap_eval-srouce-map.png)

webpack çš„ sourcemap çš„é…ç½®å°±åˆ©ç”¨äº†æµè§ˆå™¨å¯¹ eval ä»£ç çš„è°ƒè¯•æ”¯æŒã€‚

æ‰€ä»¥ä¸ºä»€ä¹ˆè¿™ä¸ªé…ç½®é¡¹ä¸å« sourcemap è€Œå« devtool å‘¢ï¼Ÿ

å› ä¸ºä¸åªæ˜¯ sourcemap å‘€ï¼Œeval çš„æ–¹å¼ä¹Ÿè¡Œã€‚


### source-map
source-map çš„é…ç½®æ˜¯ç”Ÿæˆç‹¬ç«‹çš„ sourcemap æ–‡ä»¶ï¼š

```js
module.exports = {
  entry: './src/index.js',
  devtool: 'source-map', // ç‰¹æ€§
  mode: 'development',
  // ...
}
```